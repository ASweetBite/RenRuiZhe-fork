<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://img.fastmirror.net/s/2024/08/16/66bf44708b1e7.png">
    <title>注册 </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to right, #f0f2f5, #e6e9ec);
            overflow: hidden;
        }

        .background-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #39c5bb, #bb6688);
            opacity: 0.6;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .register-container {
            position: relative;
            width: 850px;
            height: 650px;
            overflow: hidden;
        }

        .forms-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .signin-signup {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            left: 25%;
            width: 50%;
            transition: 0.5s;
            display: grid;
            grid-template-columns: 1fr;
            z-index: 10;
        }

        form {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0rem 5rem;
            transition: all 0.2s 0.7s;
            overflow: hidden;
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            pointer-events: auto !important;
        }

        .title {
            font-size: 2.2rem;
            color: #444;
            margin-bottom: 10px;
        }

        .input-field {
            max-width: 380px;
            width: 100%;
            background-color: #f0f0f0;
            margin: 10px 0;
            height: 55px;
            border-radius: 55px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .input-field i {
            text-align: center;
            line-height: 55px;
            color: #acacac;
            transition: 0.5s;
            font-size: 1.1rem;
            margin-left: 20px;
        }

        .input-field input {
            background: none;
            outline: none;
            border: none;
            line-height: 1;
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            width: 100%;
            padding: 0 15px;
        }

        .captcha-container {
            max-width: 380px;
            width: 100%;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .captcha img {
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .captcha img:hover {
            transform: scale(1.05);
        }

        .btn {
            width: 150px;
            background-color: #5995fd;
            border: none;
            outline: none;
            height: 49px;
            border-radius: 49px;
            color: #fff;
            text-transform: uppercase;
            font-weight: 600;
            margin: 10px 0;
            cursor: pointer;
            transition: 0.5s;
        }

        .btn:hover {
            background-color: #4d84e2;
        }

        .panels-container {
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            display: grid;
            grid-template-columns: 1fr;
        }

        .panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            text-align: center;
            z-index: 6;
            transition: transform 0.9s ease-in-out;
            pointer-events: auto;
        }

        .right-panel {
            position: absolute;
            right: 0;
            width: 50%;
            height: 100%;
            padding: 3rem 12% 2rem 17%;
            pointer-events: auto;
        }

        .panel .content {
            color: #fff;
            transition: transform 0.9s ease-in-out;
            transition-delay: 0.6s;
        }

        .panel h3 {
            font-weight: 600;
            line-height: 1;
            font-size: 1.5rem;
        }

        .panel p {
            font-size: 0.95rem;
            padding: 0.7rem 0;
        }

        .btn.transparent {
            margin: 0;
            background: none;
            border: 2px solid #fff;
            width: 130px;
            height: 41px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .image {
            width: 80%;
            transition: transform 1.1s ease-in-out;
            transition-delay: 0.4s;
        }

        .right-panel .image,
        .right-panel .content {
            transform: translateX(0);
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin: 5px 0;
        }

        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }

        /* 自定义表单样式 */
        .custom-form {
            width: 100%;
            max-width: 380px;
        }

        .custom-form p {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .custom-form label {
            display: none;
        }

        .custom-form input {
            width: 100%;
            background-color: #f0f0f0;
            margin: 10px 0;
            height: 55px;
            border-radius: 55px;
            padding: 0 25px;
            border: none;
            outline: none;
            font-size: 16px;
        }

        .password-strength {
            width: 100%;
            height: 5px;
            background-color: #eee;
            margin-top: 5px;
            border-radius: 10px;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            border-radius: 10px;
            transition: width 0.3s, background-color 0.3s;
        }

        .password-tips {
            width: 100%;
            max-width: 380px;
            margin-top: 5px;
            display: none;
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .tip-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.85rem;
        }
        
        .tip-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }
        
        .tip-item.valid i {
            color: #4caf50;
        }
        
        .tip-item.invalid i {
            color: #ff4d4d;
        }
        
        .password-message {
            width: 100%;
            max-width: 380px;
            margin-top: 5px;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .password-message.success {
            color: #4caf50;
        }
        
        .password-message.error {
            color: #ff4d4d;
        }

        /* 新增：隐藏 Django 默认的字段错误列表 */
        .custom-form ul.errorlist {
            display: none;
            padding: 0;
            margin: 0;
            list-style-type: none; /* 同时移除列表样式 */
        }

        .field-tips {
            width: 100%;
            max-width: 380px;
            margin: 5px 0;
            display: none;
        }

        .field-tip-item {
            display: none;
            align-items: center;
            margin: 3px 0;
            font-size: 12px;
            color: #dc3545;
        }

        .field-tip-item i {
            margin-right: 5px;
            color: #dc3545;
        }

        /* 调整输入框之间的间距 */
        .custom-form p.input-field {
            margin-bottom: 15px; /* 增加输入框之间的间距 */
        }

        /* 确保验证码容器有足够的间距 */
        .captcha-container {
            margin-top: 15px;
        }

        /* 添加验证码刷新按钮样式 */
        .captcha-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .refresh-captcha-btn {
            background-color: transparent;
            border: none;
            color: #5995fd;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .refresh-captcha-btn:hover {
            color: #4d84e2;
        }

        .refresh-captcha-btn i {
            font-size: 10px;
        }

        /* 控制表单显示/隐藏的样式 */
        form.sign-up-form {
            opacity: 1;
            z-index: 2;
        }
        
        form.sign-in-form {
            z-index: 1;
            opacity: 0;
        }
        .right-panel .btn.transparent {
            width: 150px;
            height: 49px;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px 0;
            transition: 0.5s;
        }
        
        .right-panel .btn.transparent:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* 使用更具体的选择器 */
        .register-container .panels-container .panel.right-panel .content .btn.transparent {
            width: 150px !important; /* 使用 !important 覆盖其他规则 */
            height: 49px !important;
            font-size: 1rem !important;
            font-weight: 600 !important;
            margin: 10px 0 !important;
            transition: 0.5s !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .register-container .panels-container .panel.right-panel .content .btn.transparent:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: scale(1.05) !important;
        }
    </style>
</head>
<body>
<div class="background-gradient"></div>

<div class="register-container glass-effect">
    <div class="forms-container">
        <div class="signin-signup">
            <!-- 注册表单 -->
            <form action="{% url 'user:register' %}" method="post" class="sign-up-form">
                <h2 class="title">注册</h2>
                {% csrf_token %}
                
                <!-- 手动渲染表单字段而不是使用 reg_form.as_p -->
                <div class="custom-form">
                    <!-- 用户名字段 -->
                    <p class="input-field">
                        <i class="fas fa-user"></i>
                        {{ reg_form.username }}
                    </p>
                    <div id="username-tips" class="field-tips">
                        <div id="username-length-tip" class="field-tip-item">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>用户名长度应为2-150个字符</span>
                        </div>
                        <div id="username-chars-tip" class="field-tip-item">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>用户名只能包含字母、数字和下划线</span>
                        </div>
                    </div>
                    
                    <!-- 邮箱字段 -->
                    <p class="input-field">
                        <i class="fas fa-envelope"></i>
                        {{ reg_form.email }}
                    </p>
                    <div class="field-tips" id="email-tips">
                        <div class="field-tip-item" id="email-format-tip">
                            <i class="fas fa-times"></i>
                            <span>请输入有效的电子邮箱地址</span>
                        </div>
                    </div>
                    
                    <!-- 密码字段 -->
                    <p class="input-field">
                        <i class="fas fa-lock"></i>
                        <input type="password" name="password" id="id_password" placeholder="密码" required>
                    </p>
                    
                    <!-- 确认密码字段 -->
                    <p class="input-field">
                        <i class="fas fa-lock"></i>
                        <input type="password" name="confirm_password" id="id_confirm_password" placeholder="确认密码" required>
                    </p>
                    
                    <!-- 保留验证码字段 -->
                    {{ reg_form.captcha }}
                </div>

                <div class="password-strength">
                    <div class="strength-bar"></div>
                </div>

                <div class="password-tips">
                    <div class="tip-item" id="length-tip">
                        <i class="fas fa-times"></i>
                        <span>至少8个字符</span>
                    </div>
                    <div class="tip-item" id="uppercase-tip">
                        <i class="fas fa-times"></i>
                        <span>包含大写字母</span>
                    </div>
                    <div class="tip-item" id="lowercase-tip">
                        <i class="fas fa-times"></i>
                        <span>包含小写字母</span>
                    </div>
                    <div class="tip-item" id="number-tip">
                        <i class="fas fa-times"></i>
                        <span>包含数字</span>
                    </div>
                    <div class="tip-item" id="special-tip">
                        <i class="fas fa-times"></i>
                        <span>包含特殊字符</span>
                    </div>
                </div>

                <div id="password-message" class="password-message"></div>

                <div class="captcha-container">
                    <div class="captcha-wrapper">
                        {{ captcha.captcha }}
                        <button type="button" id="refresh-captcha" class="refresh-captcha-btn">
                            <i class="fas fa-sync-alt"></i> <span>刷新验证码</span>
                        </button>
                    </div>
                    <span id="captcha_status" class="status-text"></span>
                </div>

                {% if error %}
                    <span class="error-message">{{ error }}</span>
                {% endif %}

                <input type="submit" value="注册" class="btn" id="signup-btn">
            </form>
        </div>
    </div>

    <div class="panels-container">
        <div class="panel right-panel">
            <div class="content">
                <h3>已有账号?</h3>
                <p>使用您的账号登录，畅享购物体验!</p>
                <!-- 直接修改按钮样式 -->
                <a href="{% url 'user:login' %}" class="btn transparent" style="width: 150px; height: 49px; font-size: 1rem; font-weight: 600; margin: 10px 0; display: flex; align-items: center; justify-content: center; transition: 0.5s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'; this.style.transform='scale(1.05)';" onmouseout="this.style.backgroundColor='transparent'; this.style.transform='scale(1)';">登录</a>
            </div>
            <img src="https://i.ibb.co/nP8H853/Login.png" class="image" alt="" />
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- Start of Captcha Logic (Working Version) ---
        const captchaWrapper = document.querySelector('.captcha-wrapper');
        const captchaContainer = document.querySelector('.captcha-container');

        function performCaptchaValidation(captchaInput, hashkeyInput) {
            const response = captchaInput.value.trim();
            const hashkey = hashkeyInput.value;
            if (!response || !hashkey) { return; }
            console.log('正在验证验证码:', response, '使用hashkey:', hashkey);
            if (captchaInput._validating) return;
            captchaInput._validating = true;
            fetch(`{% url 'user:ajax_val' %}?response=${response}&hashkey=${hashkey}`)
                .then(response => response.json())
                .then(data => {
                    console.log('验证码验证结果:', data);
                    let captchaStatus = document.getElementById('captcha_status');
                    if (!captchaStatus && captchaContainer) {
                        captchaStatus = document.createElement('span');
                        captchaStatus.id = 'captcha_status';
                        captchaContainer.appendChild(captchaStatus);
                    }
                    if (captchaStatus) {
                        captchaStatus.textContent = data.status ? '验证码正确' : (data.message || '验证码错误');
                        captchaStatus.className = data.status ? 'status-success' : 'status-error';
                    }
                })
                .catch(error => {
                    console.error('验证码验证错误:', error);
                    let captchaStatus = document.getElementById('captcha_status');
                     if (captchaStatus) { captchaStatus.textContent = '验证出错'; captchaStatus.className = 'status-error'; }
                })
                .finally(() => { captchaInput._validating = false; });
        }

        if (captchaWrapper) {
            captchaWrapper.addEventListener('blur', function(event) {
                if (event.target && event.target.id === 'id_captcha_1') {
                    const captchaInput = event.target;
                    let hashkeyInput = null;
                    const captchaDiv = captchaInput.closest('.captcha');
                    if (captchaDiv) { hashkeyInput = captchaDiv.querySelector('input[type="hidden"][name="captcha_0"]'); }
                    if (!hashkeyInput) { hashkeyInput = captchaWrapper.querySelector('input[type="hidden"][name="captcha_0"]'); }
                    if (captchaInput && hashkeyInput) { performCaptchaValidation(captchaInput, hashkeyInput); }
                    else { console.error("无法在 'blur' 事件中找到 hashkey 输入。"); }
                }
            }, true);
            console.log("验证码 'blur' 事件监听器已设置 (委托)。");
        } else { console.error("未能找到 '.captcha-wrapper' 元素来设置事件委托。"); }

        function refreshCaptcha() {
            const refreshButton = document.getElementById('refresh-captcha');
            const icon = refreshButton ? refreshButton.querySelector('i') : null;
            console.log("Attempting to find elements for refresh...");
            const currentCaptchaWrapper = document.querySelector('.captcha-wrapper');
            const captchaImage = currentCaptchaWrapper ? currentCaptchaWrapper.querySelector('img') : null;
            const hashkeyInput = currentCaptchaWrapper ? currentCaptchaWrapper.querySelector('input[type="hidden"][name="captcha_0"]') : null;
            const textInput = currentCaptchaWrapper ? currentCaptchaWrapper.querySelector('input[type="text"][id="id_captcha_1"]') : null;
            console.log("captchaWrapper:", currentCaptchaWrapper, "captchaImage:", captchaImage, "hashkeyInput:", hashkeyInput, "textInput:", textInput);
            if (!currentCaptchaWrapper || !captchaImage || !hashkeyInput || !textInput) {
                 if (!currentCaptchaWrapper) console.error("刷新失败: 未找到 .captcha-wrapper");
                 if (!captchaImage) console.error("刷新失败: 未找到 img 元素在 .captcha-wrapper 内");
                 if (!hashkeyInput) console.error("刷新失败: 未找到 input[name='captcha_0']");
                 if (!textInput) console.error("刷新失败: 未找到 input[id='id_captcha_1']");
                 console.error("未能找到所有必要的验证码元素。");
                 return Promise.reject("Missing captcha elements");
            }
            if (refreshButton) refreshButton.disabled = true;
            if (icon) icon.classList.add('fa-spin');
            const captchaStatus = document.getElementById('captcha_status');
            if (captchaStatus) { captchaStatus.textContent = ''; captchaStatus.className = 'status-text'; }
            return fetch("{% url 'user:refresh_captcha' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 1 && data.new_cptch_key && data.new_cptch_image_url) {
                        hashkeyInput.value = data.new_cptch_key;
                        captchaImage.src = data.new_cptch_image_url;
                        textInput.value = '';
                        console.log("验证码已通过更新 src 和 value 刷新。 新 Key:", data.new_cptch_key);
                    } else {
                        console.error("刷新请求失败或返回数据无效:", data.message || '未知错误');
                        if (captchaStatus) { captchaStatus.textContent = '刷新失败'; captchaStatus.className = 'status-error'; }
                        throw new Error(data.message || '刷新失败');
                    }
                })
                .catch(error => {
                    console.error('刷新验证码 fetch 错误:', error);
                     if (captchaStatus) { captchaStatus.textContent = '刷新出错'; captchaStatus.className = 'status-error'; }
                })
                .finally(() => {
                    if (icon) { setTimeout(() => { icon.classList.remove('fa-spin'); if (refreshButton) refreshButton.disabled = false; }, 300); }
                    else { if (refreshButton) refreshButton.disabled = false; }
                });
        }

        const refreshCaptchaBtn = document.getElementById('refresh-captcha');
        if (refreshCaptchaBtn) { refreshCaptchaBtn.addEventListener('click', refreshCaptcha); }
        if (captchaWrapper) {
            captchaWrapper.addEventListener('click', function(event) {
                if (event.target && event.target.tagName === 'IMG' && (event.target.classList.contains('captcha-image') || event.target.closest('.captcha'))) {
                    refreshCaptcha();
                }
            });
        }
        // --- End of Captcha Logic ---


        // --- Start of Password Strength Logic (Re-integrated and Checked) ---
        const passwordInput = document.querySelector('input[name="password"]');
        const confirmPasswordInput = document.querySelector('input[name="confirm_password"]');
        const strengthBar = document.querySelector('.strength-bar');
        const passwordTips = document.querySelector('.password-tips');
        const passwordMessage = document.getElementById('password-message');

        // Tip elements
        const lengthTip = document.getElementById('length-tip');
        const uppercaseTip = document.getElementById('uppercase-tip');
        const lowercaseTip = document.getElementById('lowercase-tip');
        const numberTip = document.getElementById('number-tip');
        const specialTip = document.getElementById('special-tip');

        // Function to update tip item UI
        function updateTipItem(tipElement, isValid) {
            if (!tipElement) return;
            const icon = tipElement.querySelector('i');
            if (isValid) {
                tipElement.classList.add('valid');
                tipElement.classList.remove('invalid');
                icon.className = 'fas fa-check';
            } else {
                tipElement.classList.add('invalid');
                tipElement.classList.remove('valid');
                icon.className = 'fas fa-times';
            }
        }

        // Function to check password criteria and update UI
        function checkPasswordStrength() {
            if (!passwordInput || !strengthBar || !passwordTips) {
                console.warn("Password strength elements not found.");
                return;
            }

            const password = passwordInput.value;
            let score = 0;
            let criteriaMet = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(password)
            };

            // 更新提示项 UI
            updateTipItem(lengthTip, criteriaMet.length);
            updateTipItem(uppercaseTip, criteriaMet.uppercase);
            updateTipItem(lowercaseTip, criteriaMet.lowercase);
            updateTipItem(numberTip, criteriaMet.number);
            updateTipItem(specialTip, criteriaMet.special);

            // 计算分数
            if (criteriaMet.length) score++;
            if (criteriaMet.uppercase) score++;
            if (criteriaMet.lowercase) score++;
            if (criteriaMet.number) score++;
            if (criteriaMet.special) score++;

            // 更新强度条
            const strengthPercentage = (score / 5) * 100;
            strengthBar.style.width = strengthPercentage + '%';

            if (score <= 1) {
                strengthBar.style.backgroundColor = '#ff4d4d'; // 弱 (红色)
            } else if (score <= 3) {
                strengthBar.style.backgroundColor = '#ffa500'; // 中 (橙色)
            } else if (score === 4) {
                strengthBar.style.backgroundColor = '#ffd700'; // 良好 (黄色)
            } else {
                strengthBar.style.backgroundColor = '#4caf50'; // 强 (绿色)
            }

            // 显示/隐藏提示
            if (password.length > 0) {
                passwordTips.style.display = 'block';
            } else {
                passwordTips.style.display = 'none';
            }
        }

        // Function to check if passwords match
        function checkPasswordMatch() {
             if (!passwordInput || !confirmPasswordInput || !passwordMessage) {
                 console.warn("Password confirmation elements not found.");
                 return; // Exit if elements are missing
             }
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (confirmPassword.length === 0) {
                passwordMessage.textContent = '';
                passwordMessage.className = 'password-message'; // Reset class
                confirmPasswordInput.style.borderColor = ''; // Reset border
            } else if (password === confirmPassword) {
                passwordMessage.textContent = '密码匹配';
                passwordMessage.className = 'password-message success';
                confirmPasswordInput.style.borderColor = '#4caf50'; // Green border
            } else {
                passwordMessage.textContent = '密码不匹配';
                passwordMessage.className = 'password-message error';
                confirmPasswordInput.style.borderColor = '#ff4d4d'; // Red border
            }
        }

        // Add event listeners if elements exist
        if (passwordInput) {
            passwordInput.addEventListener('input', checkPasswordStrength);
            passwordInput.addEventListener('input', checkPasswordMatch);
            passwordInput.addEventListener('focus', () => {
                if (passwordInput.value.length > 0) {
                    passwordTips.style.display = 'block';
                }
            });
            passwordInput.addEventListener('blur', () => {
                if (passwordInput.value.length === 0) {
                    passwordTips.style.display = 'none';
                }
            });
        }
        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        }
        // --- End of Password Strength Logic ---


        // --- Other JS (Username/Email validation, Form submission prevention) ---
        // Username validation (Example - keep if needed)
        const usernameInput = document.querySelector('input[name="username"]');
        const usernameTips = document.getElementById('username-tips');
        const usernameLengthTip = document.getElementById('username-length-tip');
        const usernameCharsTip = document.getElementById('username-chars-tip');

        if (usernameInput && usernameTips && usernameLengthTip && usernameCharsTip) {
            usernameInput.addEventListener('input', function() {
                const username = this.value;
                let showTips = false;
                
                // 长度检查 - 修改为2-150字符
                if (username && (username.length < 2 || username.length > 150)) {
                    usernameLengthTip.textContent = username.length < 2 ? 
                        '用户名长度不能少于2个字符' : '用户名长度不能超过150个字符';
                    usernameLengthTip.style.display = 'flex'; 
                    showTips = true;
                } else { 
                    usernameLengthTip.style.display = 'none'; 
                }
                
                // 字符检查 - 只允许字母、数字和下划线
                if (username && !/^[a-zA-Z0-9_]+$/.test(username)) {
                    usernameCharsTip.style.display = 'flex'; 
                    showTips = true;
                } else { 
                    usernameCharsTip.style.display = 'none'; 
                }
                
                usernameTips.style.display = showTips ? 'block' : 'none';
            });
            
            // 失去焦点时隐藏提示（如果输入为空）
            usernameInput.addEventListener('blur', function() { 
                if (!this.value) usernameTips.style.display = 'none'; 
            });
        }

        // Email validation (Example - keep if needed)
        const emailInput = document.querySelector('input[name="email"]');
        const emailTips = document.getElementById('email-tips');
        const emailFormatTip = document.getElementById('email-format-tip');

        if (emailInput && emailTips && emailFormatTip) {
            emailInput.addEventListener('input', function() {
                const email = this.value;
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    emailFormatTip.style.display = 'flex'; emailTips.style.display = 'block';
                } else {
                    emailFormatTip.style.display = 'none'; emailTips.style.display = 'none';
                }
            });
            emailInput.addEventListener('blur', function() { if (!this.value) emailTips.style.display = 'none'; });
        }

        // Prevent form submission if passwords don't match or captcha is invalid
        const registerForm = document.querySelector('.sign-up-form'); // Make sure this selector matches your register form
        if (registerForm) {
            registerForm.addEventListener('submit', function(e) {
                const password = passwordInput ? passwordInput.value : '';
                const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
                const captchaStatus = document.getElementById('captcha_status');

                // Check password match
                if (password !== confirmPassword && confirmPassword.length > 0) {
                    e.preventDefault();
                    alert('两次输入的密码不匹配，请检查。');
                    confirmPasswordInput.focus();
                    return;
                }

                // Check captcha status (similar to login page)
                if (captchaStatus && captchaStatus.classList.contains('status-error')) {
                     const errorText = captchaStatus.textContent;
                     if (errorText.includes('错误') || errorText.includes('Incorrect')) {
                         e.preventDefault();
                         alert('请输入正确的验证码后再提交。');
                         const captchaInput = document.getElementById('id_captcha_1');
                         if(captchaInput) captchaInput.focus();
                         return;
                     }
                }
                // Add other frontend validation checks here if needed (e.g., username format, email format)
            });
        }
        // --- End of Other JS ---

    });
</script>
</body>
</html>
